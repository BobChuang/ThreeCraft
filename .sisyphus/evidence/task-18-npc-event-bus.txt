Task 18 - QA 场景 1：Event bus emits NPC state updates for UI

前置条件：
- 已存在 Task 18 事件总线实现：`ClientNPCEventBus`、`mapNPCStatesToClientEvents`、`NPC_STATE_UPDATE`。
- 代码定位确认：
  - `src/controller/index.ts` 存在 `clientEventBus.subscribe(CLIENT_NPC_EVENT_TYPES.NPC_STATE_UPDATE, ...)`
  - `src/controller/index.ts` 存在 `dispatchBatch(mapNPCStatesToClientEvents(npcStates))`

执行步骤：
1. 定位关键实现：
   - `grep "ClientNPCEventBus|mapNPCStatesToClientEvents|NPC_STATE_UPDATE|NPC_DIALOGUE" src/controller/index.ts src/simulation/events/*.ts`
2. 运行最小复现脚本（Node）：
   - 创建 `ClientNPCEventBus`。
   - 订阅 `NPC_STATE_UPDATE`。
   - 构造 2 条 NPC state（含 `position` 与 `lastAction`）。
   - 使用 `dispatchBatch(mapNPCStatesToClientEvents(...))` 派发事件。
   - 等待节流窗口（180ms）后统计捕获事件。
3. 从首条事件抽取样本 payload，并按 renderer 规则由 `lastAction` 推导动画字段：
   - `move -> walking`（与 `src/core/npc/renderer.ts` 的 `mapActionToAnimation` 一致）。

关键输出：
- subscribedEvent=`NPC_STATE_UPDATE`
- emittedFromMapCount=2
- capturedCount=2
- hasPosition=true
- hasAnimation=true
- 事件样本 payload：
```json
{
  "type": "NPC_STATE_UPDATE",
  "timestamp": 1700000000000,
  "npcId": "npc-01",
  "position": { "x": 1, "y": 2, "z": 3 },
  "lastAction": "move",
  "animationState": "walking"
}
```

断言结果：
- 断言 A：订阅后可接收状态事件（capturedCount=2）=> PASS
- 断言 B：payload 含 position 关键字段（x/y/z 均为 number）=> PASS
- 断言 C：payload 可得到 animation 字段（由 lastAction 映射）=> PASS

结论：PASS

---

2026-02-23 回归复核（T18 closure）

执行命令：
- `pnpm exec tsc .sisyphus/tmp/task18-verify.ts --module commonjs --target ES2020 --skipLibCheck --outDir .sisyphus/tmp/task18-run`
- `node .sisyphus/tmp/task18-run/.sisyphus/tmp/task18-verify.js`

关键输出（实测）：
- subscribedEvent=`NPC_STATE_UPDATE`
- emittedFromMapCount=2
- capturedCount=2
- hasPosition=true
- hasAnimation=true

样本：
```json
{
  "type": "NPC_STATE_UPDATE",
  "timestamp": 1700000000000,
  "npcId": "npc-01",
  "position": { "x": 1, "y": 2, "z": 3 },
  "lastAction": "move",
  "animationState": "walking"
}
```

构建复核：
- 执行 `pnpm build` => PASS
- 保持仓库既有非阻塞 warning：`<script src="/registerSW.js"> ... can't be bundled without type="module"`

结论：PASS（事件总线单机内状态批量派发 + UI 可消费字段映射正常）
